{% extends "core/base.html" %}
{% load widget_tweaks %}
{% block title %}Add/Edit Inventory{% endblock %}
{% block content %}
    <div class="max-w-3xl mx-auto mt-12">
        <div class="bg-white shadow-xl rounded-3xl p-10 border border-gray-100 transition hover:shadow-2xl">
            <h1 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-2">
                {% if view.object %}
                    ✏️ Edit Inventory Entry
                {% else %}
                    ➕ Add Inventory Entry
                {% endif %}
            </h1>
            <form method="POST" class="space-y-6">
                {% csrf_token %}
                <!-- Supplier -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Supplier</label>
                    <select id="id_supplier"
                            name="supplier"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="">Select Supplier</option>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}"
                                    {% if form.instance.product and form.instance.product.supplier.id == s.id %}selected{% endif %}>
                                {{ s.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Category -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Category</label>
                    <select id="id_category"
                            name="category"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="">Select Category</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}"
                                    {% if form.instance.product and form.instance.product.category.id == c.id %}selected{% endif %}>
                                {{ c.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Subcategory -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Subcategory</label>
                    <select id="id_subcategory"
                            name="subcategory"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="">Select Subcategory</option>
                        {% for sc in subcategories %}
                            <option value="{{ sc.id }}"
                                    {% if form.instance.product and form.instance.product.subcategory.id == sc.id %}selected{% endif %}>
                                {{ sc.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Product -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Product</label>
                    <select id="id_product"
                            name="product"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="">Select Product</option>
                        {% for p in products %}
                            <option value="{{ p.id }}"
                                    {% if form.instance.product and form.instance.product.id == p.id %}selected{% endif %}>
                                {{ p.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Warehouse -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Warehouse</label>
                    {{ form.warehouse|add_class:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" }}
                </div>
                <!-- Quantity -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Quantity</label>
                    {{ form.quantity|add_class:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" }}
                </div>
                <!-- Reorder Level -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Reorder Level</label>
                    {{ form.reorder_level|add_class:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" }}
                </div>
                <!-- Submit -->
                <div class="flex justify-end pt-4">
                    <button type="submit"
                            class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition-transform transform hover:-translate-y-0.5">
                        {% if view.object %}
                            Update
                        {% else %}
                            Add
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const subcategoryUrl = "{% url 'product:ajax_load_subcategories' %}";
    const productUrl = "{% url 'product:ajax_load_products' %}";

    const supplierSelect = document.getElementById("id_supplier");
    const categorySelect = document.getElementById("id_category");
    const subcategorySelect = document.getElementById("id_subcategory");
    const productSelect = document.getElementById("id_product");

    function loadSubcategories(categoryId, selectedId = null) {
        if (!categoryId) {
            subcategorySelect.innerHTML = "<option value=''>Select Subcategory</option>";
            return;
        }
        fetch(`${subcategoryUrl}?category=${categoryId}`)
            .then(res => res.json())
            .then(data => {
                subcategorySelect.innerHTML = "<option value=''>Select Subcategory</option>";
                data.forEach(item => {
                    subcategorySelect.innerHTML += `<option value='${item.id}' ${item.id == selectedId ? "selected" : ""}>${item.name}</option>`;
                });
            });
    }

    function loadProducts(subcategoryId, supplierId, selectedId = null) {
        if (!subcategoryId || !supplierId) return;
        const params = new URLSearchParams({ subcategory: subcategoryId, supplier: supplierId });
        fetch(`${productUrl}?${params}`)
            .then(res => res.json())
            .then(data => {
                productSelect.innerHTML = "<option value=''>Select Product</option>";
                data.forEach(item => {
                    productSelect.innerHTML += `<option value='${item.id}' ${item.id == selectedId ? "selected" : ""}>${item.name}</option>`;
                });
            });
    }

    // Preload for Edit Mode
    const selectedCategory = categorySelect.value;
    const selectedSupplier = supplierSelect.value;
    const selectedSubcategory = "{{ form.instance.product.subcategory.id|default:'' }}";
    const selectedProduct = "{{ form.instance.product.id|default:'' }}";

    if (selectedCategory && selectedSubcategory) loadSubcategories(selectedCategory, selectedSubcategory);
    if (selectedSubcategory && selectedSupplier && selectedProduct)
        loadProducts(selectedSubcategory, selectedSupplier, selectedProduct);

    // On change
    categorySelect.addEventListener("change", () => {
        loadSubcategories(categorySelect.value);
        productSelect.innerHTML = "<option value=''>Select Product</option>";
    });
    [subcategorySelect, supplierSelect].forEach(sel => {
        sel.addEventListener("change", () => {
            loadProducts(subcategorySelect.value, supplierSelect.value);
        });
    });
});
    </script>
{% endblock %}
